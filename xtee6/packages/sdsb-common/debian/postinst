#!/bin/sh

set -e
. /usr/share/debconf/confmodule
db_stop



if [ "$1" = configure ]; then
    # Make sure the administrative user exists
    if ! getent passwd sdsb > /dev/null; then
        adduser --system --quiet --home /var/lib/sdsb --no-create-home \
            --shell /bin/bash --group --gecos "SDSB Service" sdsb
    fi

    # check validity of sdsb user and group
    if [ "`id -u sdsb`" -eq 0 ]; then
        echo "The sdsb system user must not have uid 0 (root).
Please fix this and reinstall this package." >&2
        exit 1
    fi
    if [ "`id -g sdsb`" -eq 0 ]; then
        echo "The sdsb system user must not have root as primary group.
Please fix this and reinstall this package." >&2
        exit 1
    fi
    #add sdsb to shadow group for pam 
    adduser sdsb shadow

    #enable ACL
    mount -o remount,acl `df  /etc/sdsb/ | awk '/^\/dev/ {print $1}'`
    chown sdsb:sdsb /etc/sdsb
    setfacl -m "default:group::rw" /etc/sdsb/

    # ensure home directory ownership
    mkdir -p /var/lib/sdsb/backup
    su - sdsb -c "test -O /var/lib/sdsb &&
            test -G /var/lib/sdsb" || \
        chown sdsb:sdsb /var/lib/sdsb 
    chown sdsb:sdsb /var/lib/sdsb/backup
    chmod 0775 /var/lib/sdsb

    # nicer log directory permissions
    mkdir -p -m1770 /var/log/sdsb
    chmod 1770 /var/log/sdsb
    chown sdsb:sdsb /var/log/sdsb

    # test and fix config folder
    su - sdsb -c "test -O /etc/sdsb &&
            test -G /etc/sdsb" || \
        chown sdsb:sdsb /etc/sdsb
    chmod 0770 /etc/sdsb

    #tmp folder
    mkdir -p /var/tmp/sdsb
    chmod 1770 /var/tmp/sdsb
    chown sdsb:sdsb /var/tmp/sdsb


    # create socket directory
    [ -d /var/run/sdsb ] || \
       install -d -m 2770 -o sdsb -g sdsb /var/run/sdsb


fi    

service sdsb-signer restart || service sdsb-signer start

exit 0
