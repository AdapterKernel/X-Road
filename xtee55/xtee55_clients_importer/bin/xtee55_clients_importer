#!/usr/share/sdsb/jruby/bin/jruby

require 'rubygems'
require 'java'

require 'xtee55_clients_importer'

include Xtee55ClientsImporter

def getRootCauseMessage(java_exception)
    Java::org.apache.commons.lang3.exception.ExceptionUtils.getRootCauseMessage(
        java_exception)
end

class Xtee55ClientsImporterMain
  @@log = xlogger(Xtee55ClientsImporterMain)

  def self.run(opts)
    begin
      parser = Parser.new(opts.data_file)
      parser.parse()

      res = DBManager.new(opts.host, opts.database, opts.username, opts.password).
          import(parser.groups, parser.consumers, parser.producers)
    rescue Exception
      @@log.error($!.message)
      exit 2
    rescue Java::java.lang.Exception
      @@log.error(getRootCauseMessage($!))
      exit 2
    end

    exit res
  end
end

Xtee55ClientsImporterMain.run(Options.new(ARGV))
