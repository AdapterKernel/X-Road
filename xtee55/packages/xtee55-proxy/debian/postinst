#!/bin/sh

if [ "$1" = configure ]; then
  if getent group xtee > /dev/null; then
    adduser xroad xtee
  fi
fi

test -w /usr/xtee/etc/ && touch /usr/xtee/etc/v6_xroad_installed && chmod 644 /usr/xtee/etc/v6_xroad_installed

/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy -k client-http-port -v 8080
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy -k client-https-port -v 8443
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy -k verify-client-cert -v false
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy -k log-both-messages -v false
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s monitoringagent -k uri -v akka.tcp://XroadMonitoringAgent@127.0.0.1:2553/user/DataReceiver

# Remove legacy sites
rm -f /etc/nginx/sites-enabled/xtee55-clientmediator*
rm -f /etc/nginx/sites-enabled/xroad_proxy_disabled

# Remove legacy values from local.ini
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy -k server-listen-port
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy -k ocsp-responder-port
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy -k server-listen-address
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy -k ocsp-responder-listen-address

if [ -f /usr/xtee/etc/v6_xroad_activated ]; then
  /usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s client-mediator -k http-port -v 80
  /usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s client-mediator -k https-port -v 443
fi

# Set the X-Road 5.5 commands needed by the proxy UI.
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy-ui -k service-importer-command -v /usr/share/xroad/scripts/import_v5_services.sh
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy-ui -k tls-key-importer-command -v /usr/share/xroad/scripts/import_v5_internal_tls_key_wrapper.sh
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy-ui -k tls-key-exporter-command -v /usr/share/xroad/scripts/export_v6_internal_tls_key_wrapper.sh
# Remove the X-Road 5.5 legacy commands needed by the proxy UI.
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy-ui -k service-exporter-command
/usr/share/xroad/scripts/modify_inifile.py -f /etc/xroad/conf.d/local.ini -s proxy-ui -k internal-ssl-exporter-command

chmod 0440 /etc/sudoers.d/xtee

# Needed if legacy sites were used by nginx.
service nginx restart || service nginx start

service xroad-proxy restart || service xroad-proxy start
service xtee55-clientmediator restart || service xtee55-clientmediator start
service xtee55-monitor restart || service xtee55-monitor start
service xroad-jetty restart || service xroad-jetty start

exit 0
